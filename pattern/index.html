<!DOCTYPE html>
<html style="position: relative; min-height: 100%;">
  <head>
    <meta charset="utf-8">
    <title>ruby app</title>  
  </head>
  <body style="margin-bottom: 350px; font-size: 10pt; font-family: Consolas, LucidaConsole, MonoSans, monospace;">
    <p id="load-progress" class="content" style="white-space: pre-wrap;">loading jquery...</p>
    <div id="input-area" style="position: absolute; bottom: 0px; height: 350px; display: none;">
        <p id="doc" style="border-left: 2px solid black; width: 500px; height: 12px; padding-left: 1em;">Enter will check code's syntax</p>
        <div id="input" style="width: 500px; height: 300px;">class Pattern
  def initialize(name)
    @name = name
  end
  def to_s() @name.to_s end
end

Pattern.new("example")</div>
    </div>
    <script src="fx/jquery.min.js"></script>
    <script type="text/javascript">$("#load-progress").html("loading bootstrap...")</script>
    <link type="stylesheet" rel="fx/bootstrap.min.css"></link>
    <script type="text/javascript">$("#load-progress").html("loading opal...")</script>
    <script src="fx/opal.min.js"></script>
    <script type="text/javascript">$("#load-progress").html("loading opal jquery...")</script>
    <script src="fx/opal-jquery-0.4.2.js"></script>
    <script type="text/javascript">$("#load-progress").html("loading opal parser...")</script>
    <script src="fx/opal-parser.min.js"></script>
    <script type="text/javascript">$("#load-progress").html("loading ace code editor...")</script>
    <script src="fx/ace/ace.js" type="text/javascript"></script>
    <script>
        var editor = ace.edit("input");
        editor.getSession().setMode("ace/mode/ruby");
        $("#input-area").show();
    </script>
    <script type="text/javascript">$("#load-progress").html("starting opal parser...")</script>
    <script type="text/javascript">Opal.load('opal-parser')</script>  
    <script type="text/javascript">$("#load-progress").html("evaluating ruby...")</script>
    <script type="text/ruby">
class Program
  def initialize()
    @next = ""
    @output = ""
    @input = ""
    @ok = true
  end

  def refresh()
    Element['.content'].html = @output
    use_input()
  end

  def puts(*args)
    res = ""
    for i in args
      res += i.to_s
    end
    @output += "\n" + res

    refresh()
    #Kernel.puts(*args)
  end

  def gets()
    @ok = false
    #@input = Kernel.gets
  end

  def clear_screen()
    @output = ""
    refresh()
    # puts("\n" * 50)
  end

  def main()
    intro = <<INTRO
    Welcome to the Ruby shell!
    Press Control+Enter or Shift+Enter to run your code.
INTRO
    puts(intro)
    gets
    @next = "main"
  end

  def use_input()
    Element['#input'].focus()
    `window.scrollTo(0, document.body.scrollHeight)`
    # $window.to(0, Element['body'][0].scroll_height)
  end

  def selected(value)
    #if (Object.const_defined?(value) rescue false)
    #  clazz = (Object.const_get(value) rescue nil)
    #  Element['#doc'].html = "a#{clazz}.#{clazz.instance_methods(false)}\n#{clazz}.#{clazz.methods(false)}"
    #end
  end

  def input_done(value, run)
    @input = value
    @ok = true
    state = "-> "
    last_has_error = @has_error
    begin
      if !run then value = "return nil;\n" + value end
      res = Program.class_eval(value)
      @has_error = false
    rescue Exception => e
      state = ""
      @has_error = true
      res = e
    end
    if !@has_error
      nl = "\n"
      Element['#doc'].html = "No syntax errors. Press Control+Enter or Shift+Enter to execute."
      if last_has_error then clear_screen() end
    elsif @has_error
      Element['#doc'].html = "#{e.class} detected. Try to locate the error by checking the error message."
    end
    if(run || state == "")
      clear_screen()
      #@output += "> " + @input
      #refresh()
      puts("#{state}#{res.class} #{res}\n")
    end
  end

  def self.class_eval(code)
    eval(code)
  end

  def method_missing(proc, *args)
    raise("Your code doesn't have a definition for:\n#{proc}\nIt was called with args: #{args}")
  end
end

Document.ready? do
  prog = Program.new()
  input_elem = Element['#input']
  input_elem.on(:keyup) do |event|
    if(event.key_code == 13)
      run = event.ctrl_key || event.shift_key
      prog.input_done(`editor.session.getValue()`, run)
    end
  end
  prog.main()
end
    </script>
  </body>
</html>